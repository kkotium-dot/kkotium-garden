'use client';

import { useState, useCallback, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import ImageUploader from '@/components/products/ImageUploader';
import ProductSeoForm from './seo/ProductSeoForm';
import { Save, Loader2, ArrowLeft, Package, Image as ImageIcon, FileText, TrendingUp, Truck } from 'lucide-react';
import Link from 'next/link';

interface ProductFormProps {
  initialData?: any;
  onSave?: (data: any) => Promise<void>;
  loading?: boolean;
  mode?: string;
}

// âœ… SKU ì˜ë¬¸ ìƒì„± (í•œê¸€ â†’ ì˜ë¬¸ ì•½ì)
function generateEnglishSKU(name: string): string {
  const koreanToEnglish: Record<string, string> = {
    'í”„ë¦¬ë¯¸ì—„': 'PREM',
    'ì¥ë¯¸': 'ROSE',
    'ê½ƒë‹¤ë°œ': 'BQT',
    'íŠ¤ë¦½': 'TULP',
    'í•´ë°”ë¼ê¸°': 'SUNF',
    'ë°±í•©': 'LILY',
    'ì¹´ë„¤ì´ì…˜': 'CARN',
    'êµ­í™”': 'CHRY',
    'ë‚œì´ˆ': 'ORCH',
    'ë¶€ì¼€': 'BOUQ',
    'í™”í™˜': 'WREA',
    'ë°”êµ¬ë‹ˆ': 'BASK',
    'í¬íŠ¸': 'POT',
    'ì„¸íŠ¸': 'SET',
    'ì„ ë¬¼': 'GIFT',
    'ìƒì¼': 'BDAY',
    'ê²°í˜¼': 'WED',
    'ê¸°ë…ì¼': 'ANNI',
  };

  let prefix = '';
  for (const [kor, eng] of Object.entries(koreanToEnglish)) {
    if (name.includes(kor)) {
      prefix = eng;
      break;
    }
  }

  if (!prefix) {
    const words = name.match(/[a-zA-Z]+/g);
    if (words && words.length > 0) {
      prefix = words[0].substring(0, 4).toUpperCase();
    }
  }

  const randomStr = Math.random().toString(36).substring(2, 8).toUpperCase();
  return `PROD-${prefix || randomStr.substring(0, 4)}${randomStr.substring(0, 2)}`;
}

export default function ProductForm({ initialData, onSave, loading: externalLoading, mode = 'create' }: ProductFormProps) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [activeTab, setActiveTab] = useState<'basic' | 'images' | 'detail' | 'seo'>('basic');

  const [supplier, setSupplier] = useState<{
    id: string;
    name: string;
    code: string;
  }>(initialData?.supplier || {
    id: initialData?.supplierId || 'kkotium-default',
    name: initialData?.supplierName || 'ê½ƒí‹”ì›€(í˜‘ë ¥ì‚¬)',
    code: initialData?.supplierCode || 'KKOTIUM'
  });

  const [formData, setFormData] = useState({
    name: initialData?.name || '',
    sku: initialData?.sku || '',
    category: initialData?.category || '',
    salePrice: initialData?.salePrice?.toString() || '',
    supplierPrice: initialData?.supplierPrice?.toString() || '',
    stock: initialData?.stock?.toString() || '',
    brand: initialData?.brand || '',
    manufacturer: initialData?.manufacturer || '',
    origin: initialData?.origin || '',
    shippingFee: initialData?.shippingFee?.toString() || '',
    status: initialData?.status || 'draft',
  });

  const [detailDescription, setDetailDescription] = useState(initialData?.detailDescription || '');

  const [images, setImages] = useState<Array<{ url: string; isMain: boolean; altText: string }>>(
    Array.isArray(initialData?.images) 
      ? initialData.images.map((url: string, i: number) => ({ url, isMain: i === 0, altText: '' }))
      : []
  );

  const [seoData, setSeoData] = useState({
    title: initialData?.title || '',
    description: initialData?.description || '',
    keywords: initialData?.keywords || '',
    naver_title: initialData?.naver_title || '',
    naver_description: initialData?.naver_description || '',
    naver_keywords: initialData?.naver_keywords || '',
    og_image: initialData?.og_image || '',
    seo_score: initialData?.seo_score || 0,
    seo_valid: initialData?.seo_valid || false,
  });

  // âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ (ImageUploader ì½œë°±ìš©)
  const handleImageUpload = useCallback((imageData: { url: string; isMain: boolean; altText: string }) => {
    setImages(prev => {
      // ìƒˆ ì´ë¯¸ì§€ê°€ ë©”ì¸ì´ë©´ ê¸°ì¡´ ë©”ì¸ í•´ì œ
      if (imageData.isMain) {
        return [...prev.map(img => ({ ...img, isMain: false })), imageData];
      }
      return [...prev, imageData];
    });
  }, []);

  // âœ… ì´ë¯¸ì§€ ì‚­ì œ í•¸ë“¤ëŸ¬
  const handleImageDelete = useCallback((url: string) => {
    setImages(prev => {
      const filtered = prev.filter(img => img.url !== url);
      // ë©”ì¸ ì´ë¯¸ì§€ê°€ ì‚­ì œë˜ë©´ ì²« ë²ˆì§¸ë¥¼ ë©”ì¸ìœ¼ë¡œ
      if (filtered.length > 0 && !filtered.some(img => img.isMain)) {
        filtered[0].isMain = true;
      }
      return filtered;
    });
  }, []);

  const calculateMargin = useCallback(() => {
    const salePrice = parseFloat(formData.salePrice) || 0;
    const supplierPrice = parseFloat(formData.supplierPrice) || 0;
    if (salePrice === 0) return '0';
    const margin = ((salePrice - supplierPrice) / salePrice) * 100;
    return margin.toFixed(1);
  }, [formData.salePrice, formData.supplierPrice]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!formData.name.trim()) {
      alert('âŒ ìƒí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
      setActiveTab('basic');
      return;
    }

    const finalSku = formData.sku || generateEnglishSKU(formData.name);

    if (!formData.category.trim()) {
      alert('âŒ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
      setActiveTab('basic');
      return;
    }

    if (!formData.salePrice || parseFloat(formData.salePrice) < 10) {
      alert('âŒ íŒë§¤ê°€ëŠ” ìµœì†Œ 10ì› ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤');
      setActiveTab('basic');
      return;
    }

    if (!formData.stock || parseInt(formData.stock) < 1) {
      alert('âŒ ì¬ê³ ìˆ˜ëŸ‰ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
      setActiveTab('basic');
      return;
    }

    if (images.length === 0) {
      const confirmImage = window.confirm(
        'âš ï¸ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.\n\n' +
        'ì´ë¯¸ì§€ ì—†ì´ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n' +
        '(ë‚˜ì¤‘ì— ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤)'
      );
      if (!confirmImage) {
        setActiveTab('images');
        return;
      }
    }

    const seoScore = seoData.seo_score;
    let seoWarning = '';

    if (seoScore < 50) {
      seoWarning = 
        `âš ï¸ SEO ì ìˆ˜: ${seoScore}ì  (ë‚®ìŒ)\n\n` +
        `â€¢ 0-49ì : ê²€ìƒ‰ ë…¸ì¶œ ë§¤ìš° ë‚®ìŒ\n` +
        `â€¢ 50-79ì : ì¼ë°˜ ë…¸ì¶œ\n` +
        `â€¢ 80-100ì : ìš°ì„  ë…¸ì¶œ (ê¶Œì¥)\n\n` +
        `ì§€ê¸ˆ ë“±ë¡í•˜ê³  ë‚˜ì¤‘ì— SEOë¥¼ ê°œì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
    } else if (seoScore < 80) {
      seoWarning = 
        `â„¹ï¸ SEO ì ìˆ˜: ${seoScore}ì  (ë³´í†µ)\n\n` +
        `80ì  ì´ìƒ ê¶Œì¥ (ìš°ì„  ë…¸ì¶œ)\n\n` +
        `ì§€ê¸ˆ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
    }

    if (seoWarning) {
      const confirmSEO = window.confirm(seoWarning);
      if (!confirmSEO) {
        setActiveTab('seo');
        return;
      }
    }

    const margin = parseFloat(calculateMargin());
    const submitData = {
      name: formData.name.trim(),
      sku: finalSku,
      category: formData.category.trim(),
      salePrice: parseFloat(formData.salePrice),
      supplierPrice: parseFloat(formData.supplierPrice) || 0,
      stock: parseInt(formData.stock),
      brand: formData.brand.trim() || 'ê½ƒí‹”ì›€',
      manufacturer: formData.manufacturer.trim() || 'ê½ƒí‹”ì›€(í˜‘ë ¥ì‚¬)',
      origin: formData.origin,
      shippingFee: parseFloat(formData.shippingFee) || 0,
      status: formData.status,
      supplierId: supplier.id,
      supplierCode: supplier.code,
      supplierName: supplier.name,
      images: images.map(img => img.url),
      imageAltTexts: images.map(img => img.altText),
      mainImage: images.find(img => img.isMain)?.url || images[0]?.url || null,
      detailDescription: detailDescription.trim(),
      title: seoData.title?.trim() || '',
      description: seoData.description?.trim() || '',
      keywords: seoData.keywords?.trim() || '',
      naver_title: seoData.naver_title?.trim() || formData.name,
      naver_description: seoData.naver_description?.trim() || '',
      naver_brand: formData.brand?.trim() || 'ê½ƒí‹”ì›€',
      naver_manufacturer: formData.manufacturer?.trim() || 'ê½ƒí‹”ì›€(í˜‘ë ¥ì‚¬)',
      naver_origin: formData.origin,
      naver_keywords: seoData.keywords?.trim() || '',
      og_image: seoData.og_image?.trim() || images[0]?.url || '',
      seo_score: seoData.seo_score,
      seo_valid: seoData.seo_score >= 50,
      margin,
    };

    try {
      if (onSave) {
        await onSave(submitData);
      } else {
        setLoading(true);
        const response = await fetch('/api/products', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(submitData),
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error || result.details || 'ìƒí’ˆ ë“±ë¡ ì‹¤íŒ¨');
        }

        alert('âœ… ìƒí’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤');
        router.push('/products');
      }
    } catch (error: any) {
      console.error('âŒ ì œì¶œ ì‹¤íŒ¨:', error);
      alert(`âŒ ìƒí’ˆ ë“±ë¡ ì‹¤íŒ¨: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };

  const isFormValid = 
    formData.name.trim().length > 0 &&
    formData.category.trim().length > 0 && 
    parseFloat(formData.salePrice) >= 10 &&
    parseInt(formData.stock) >= 1;

  const getSeoGrade = (score: number) => {
    if (score >= 80) return { grade: 'A', color: 'from-green-400 to-emerald-500', text: 'ìš°ìˆ˜' };
    if (score >= 50) return { grade: 'B', color: 'from-yellow-400 to-orange-400', text: 'ë³´í†µ' };
    return { grade: 'C', color: 'from-red-400 to-pink-500', text: 'ë‚®ìŒ' };
  };

  const seoGrade = getSeoGrade(seoData.seo_score);

  return (
    <form onSubmit={handleSubmit} className="max-w-5xl mx-auto space-y-6 pb-20">
      {/* í—¤ë” */}
      <div className="flex items-center justify-between bg-white p-6 rounded-2xl shadow-lg border-2 border-pink-100">
        <div>
          <h1 className="text-3xl font-black text-gray-900">
            {mode === 'create' ? 'ğŸ“¦ ìƒí’ˆ ë“±ë¡' : 'âœï¸ ìƒí’ˆ ìˆ˜ì •'}
          </h1>
          <p className="text-lg text-gray-600 mt-1">
            ê³µê¸‰ì‚¬: <span className="font-bold text-pink-600">{supplier.name}</span>
          </p>
        </div>
        <div className="text-right">
          <div className={`px-6 py-3 rounded-full text-base font-bold shadow-md bg-gradient-to-r ${seoGrade.color} text-white`}>
            SEO {seoData.seo_score}/100 ({seoGrade.grade}ë“±ê¸‰)
          </div>
          <p className="text-sm text-gray-500 mt-1">{seoGrade.text}</p>
        </div>
      </div>

      {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
      <div className="bg-white rounded-2xl shadow-lg p-2 border-2 border-pink-100">
        <div className="flex gap-2">
          {[
            { id: 'basic' as const, icon: Package, label: 'ê¸°ë³¸ì •ë³´' },
            { id: 'images' as const, icon: ImageIcon, label: `ì´ë¯¸ì§€ (${images.length})` },
            { id: 'detail' as const, icon: FileText, label: 'ìƒì„¸ì„¤ëª…' },
            { id: 'seo' as const, icon: TrendingUp, label: 'SEO' },
          ].map(({ id, icon: Icon, label }) => (
            <button
              key={id}
              type="button"
              onClick={() => setActiveTab(id)}
              className={`flex-1 flex items-center justify-center gap-2 px-6 py-3 rounded-xl font-bold transition-all ${
                activeTab === id
                  ? 'bg-gradient-to-r from-pink-500 to-purple-600 text-white shadow-lg'
                  : 'text-gray-600 hover:bg-gray-100'
              }`}
            >
              <Icon className="w-5 h-5" />
              {label}
            </button>
          ))}
        </div>
      </div>

      {/* íƒ­ ì»¨í…ì¸  */}
      <div className="bg-white rounded-2xl shadow-lg p-8 border-2 border-pink-100">
        {activeTab === 'basic' && (
          <div className="space-y-6">
            <h2 className="text-2xl font-black text-gray-900 flex items-center gap-2">
              <Package className="w-7 h-7 text-pink-600" />
              ê¸°ë³¸ ì •ë³´
            </h2>

            <div>
              <label className="block text-sm font-bold text-gray-700 mb-2">
                ìƒí’ˆëª… <span className="text-red-500">*</span>
              </label>
              <input
                type="text"
                value={formData.name}
                onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200"
                placeholder="í”„ë¦¬ë¯¸ì—„ ì¥ë¯¸ ê½ƒë‹¤ë°œ (ë¹¨ê°•)"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-bold text-gray-700 mb-2">
                SKU <span className="text-green-600 text-xs">âœ“ ìë™ìƒì„±</span>
              </label>
              <input
                type="text"
                value={formData.sku}
                onChange={(e) => setFormData({ ...formData, sku: e.target.value })}
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl bg-green-50"
                placeholder="ìë™ ìƒì„±ë¨"
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">
                  ì¹´í…Œê³ ë¦¬ <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  value={formData.category}
                  onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-pink-500"
                  placeholder="ì£¼ë°©/ìƒí™œ"
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">
                  íŒë§¤ê°€ <span className="text-red-500">*</span>
                </label>
                <input
                  type="number"
                  value={formData.salePrice}
                  onChange={(e) => setFormData({ ...formData, salePrice: e.target.value })}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-pink-500"
                  placeholder="35000"
                  required
                  min="10"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">ê³µê¸‰ê°€</label>
                <input
                  type="number"
                  value={formData.supplierPrice}
                  onChange={(e) => setFormData({ ...formData, supplierPrice: e.target.value })}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl"
                  placeholder="21000"
                />
                <p className="text-sm text-gray-500 mt-1">
                  ğŸ’° ë§ˆì§„ìœ¨: {calculateMargin()}%
                </p>
              </div>
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">
                  ì¬ê³ ìˆ˜ëŸ‰ <span className="text-red-500">*</span>
                </label>
                <input
                  type="number"
                  value={formData.stock}
                  onChange={(e) => setFormData({ ...formData, stock: e.target.value })}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-pink-500"
                  placeholder="100"
                  required
                  min="1"
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-bold text-gray-700 mb-2">ë°°ì†¡ë¹„</label>
              <input
                type="number"
                value={formData.shippingFee}
                onChange={(e) => setFormData({ ...formData, shippingFee: e.target.value })}
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl"
                placeholder="3500"
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">
                  ë¸Œëœë“œ <span className="text-yellow-600 text-xs">â­ ê²€ìƒ‰ ë…¸ì¶œ í•„ìˆ˜</span>
                </label>
                <input
                  type="text"
                  value={formData.brand}
                  onChange={(e) => setFormData({ ...formData, brand: e.target.value })}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl"
                  placeholder="ë¼ì´í”„ìŠ¤íƒ€ì¼"
                />
              </div>
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">
                  ì œì¡°ì‚¬ <span className="text-yellow-600 text-xs">â­ ì‹ ë¢°ë„</span>
                </label>
                <input
                  type="text"
                  value={formData.manufacturer}
                  onChange={(e) => setFormData({ ...formData, manufacturer: e.target.value })}
                  className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl"
                  placeholder="ê½ƒí‹”ì›€(í˜‘ë ¥ì‚¬)"
                />
              </div>
            </div>

            <div>
              <label className="block text-sm font-bold text-gray-700 mb-2">
                ì›ì‚°ì§€ <span className="text-yellow-600 text-xs">â­ í•„ìˆ˜</span>
              </label>
              <select
                value={formData.origin}
                onChange={(e) => setFormData({ ...formData, origin: e.target.value })}
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl"
              >
                <option value="">ì„ íƒ</option>
                <option value="0200037">í•œêµ­ì‚°</option>
                <option value="0200038">ì¤‘êµ­ì‚°</option>
                <option value="0200039">ì¼ë³¸ì‚°</option>
              </select>
            </div>
          </div>
        )}

        {activeTab === 'images' && (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <h2 className="text-2xl font-black text-gray-900 flex items-center gap-2">
                <ImageIcon className="w-7 h-7 text-pink-600" />
                ì´ë¯¸ì§€ ({images.length}ê°œ)
              </h2>
              <p className="text-sm text-gray-500">
                {images.length === 0 && 'âš ï¸ ê¶Œì¥: 3ê°œ ì´ìƒ'}
                {images.length >= 3 && 'âœ… ìµœì í™”ë¨'}
              </p>
            </div>
            <ImageUploader
              existingImages={images}
              onUploadSuccess={handleImageUpload}
              onDeleteSuccess={handleImageDelete}
              maxImages={10}
            />
          </div>
        )}

        {activeTab === 'detail' && (
          <div className="space-y-6">
            <h2 className="text-2xl font-black text-gray-900 flex items-center gap-2">
              <FileText className="w-7 h-7 text-pink-600" />
              ìƒì„¸ì„¤ëª…
            </h2>
            <textarea
              value={detailDescription}
              onChange={(e) => setDetailDescription(e.target.value)}
              className="w-full h-64 px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-pink-500 focus:ring-2 focus:ring-pink-200"
              placeholder="ì œí’ˆ ìˆ˜ë ¹ í›„ 7ì¼ ì´ë‚´ êµí™˜/í™˜ë¶ˆ ê°€ëŠ¥..."
            />
          </div>
        )}

        {activeTab === 'seo' && (
          <ProductSeoForm
            seoData={seoData}
            onSeoChange={setSeoData}
          />
        )}
      </div>

      {/* ì œì¶œ ë²„íŠ¼ */}
      <div className="flex items-center justify-between bg-white p-6 rounded-2xl shadow-lg border-2 border-pink-100">
        <Link
          href="/products"
          className="px-8 py-4 rounded-xl font-bold text-lg flex items-center gap-2 text-gray-600 hover:bg-gray-100 transition-all"
        >
          <ArrowLeft className="w-5 h-5" />
          ëª©ë¡ìœ¼ë¡œ
        </Link>

        <button
          type="submit"
          disabled={loading || !isFormValid}
          className={`px-12 py-4 rounded-xl font-black text-lg flex items-center gap-3 transition-all shadow-xl ${
            isFormValid && !loading
              ? 'bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white hover:shadow-2xl hover:-translate-y-1'
              : 'bg-gray-300 text-gray-500 cursor-not-allowed'
          }`}
        >
          {loading || externalLoading ? (
            <>
              <Loader2 className="w-6 h-6 animate-spin" />
              ë“±ë¡ì¤‘...
            </>
          ) : (
            <>
              <Save className="w-6 h-6" />
              {mode === 'create' ? 'ìƒí’ˆ ë“±ë¡í•˜ê¸°' : 'ìˆ˜ì • ì™„ë£Œ'}
            </>
          )}
        </button>
      </div>
    </form>
  );
}
