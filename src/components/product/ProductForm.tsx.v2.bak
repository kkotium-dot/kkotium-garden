'use client';

import { useState, useEffect, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import ImageUploader from '@/components/products/ImageUploader';
import ProductSeoForm from './seo/ProductSeoForm';
import { Save, Loader2, ArrowLeft, Eye } from 'lucide-react';
import Link from 'next/link';

interface ProductFormProps {
  initialData?: any;
  onSave: (data: any) => Promise<void>;
  loading?: boolean;
  mode: 'create' | 'edit';
}

interface SeoFields {
  title: string;
  description: string;
  keywords: string;
  naver_title: string;
  naver_description: string;
  og_image: string;
  seo_score: number;
  seo_valid: boolean;
}

export default function ProductForm({ 
  initialData = {}, 
  onSave, 
  loading = false, 
  mode 
}: ProductFormProps) {
  const router = useRouter();

  // 내장 SEO 로직 (Hook 독립)
  const [seoFields, setSeoFields] = useState<SeoFields>({
    title: initialData.title || '',
    description: initialData.description || '',
    keywords: initialData.keywords || '',
    naver_title: initialData.naver_title || '',
    naver_description: initialData.naver_description || '',
    og_image: initialData.og_image || '',
    seo_score: initialData.seo_score || 0,
    seo_valid: false,
  });

  const [activeTab, setActiveTab] = useState<'basic' | 'images' | 'seo'>('basic');
  const [formData, setFormData] = useState({
    name: initialData.name || '',
    salePrice: initialData.salePrice || '',
    supplierPrice: initialData.supplierPrice || '',
    shippingFee: initialData.shippingFee || '',
    category: initialData.category || '',
    status: initialData.status || 'draft',
    sku: initialData.sku || '',
    supplierId: initialData.supplierId || '',
    images: initialData.images || [],
    imageAltTexts: initialData.imageAltTexts || [],
  });

  // SEO 실시간 검증
  const validateSeo = useCallback(() => {
    let score = 0;
    if (seoFields.title.length >= 10) score += 20;
    if (seoFields.description.length >= 50) score += 25;
    if (seoFields.keywords.split(',').filter(Boolean).length >= 3) score += 15;
    if (seoFields.naver_title.length >= 10) score += 20;
    if (seoFields.naver_description.length >= 50) score += 20;

    const valid = score >= 80;
    setSeoFields(prev => ({ ...prev, seo_score: score, seo_valid: valid }));
    return { valid, score };
  }, [seoFields]);

  const updateSeoFields = useCallback((updates: Partial<SeoFields>) => {
    setSeoFields(prev => ({ ...prev, ...updates }));
  }, []);

  const updateFormData = useCallback((updates: any) => {
    setFormData(prev => ({ ...prev, ...updates }));
  }, []);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    const seoResult = validateSeo();

    if (!seoResult.valid) {
      alert(`SEO 점수 ${seoResult.score}점 (80점 이상 필요)`);
      setActiveTab('seo');
      return;
    }

    const submitData = {
      ...formData,
      ...seoFields,
      seo_score: seoResult.score,
      seo_valid: true,
    };

    await onSave(submitData);
  };

  useEffect(() => {
    validateSeo();
  }, [seoFields, validateSeo]);

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <div className="border-b border-gray-200 pb-6">
        <div className="flex gap-4 mb-4">
          <button
            type="button"
            className={`px-6 py-2 rounded-lg font-medium ${activeTab === 'basic' ? 'bg-pink-100 text-pink-800' : 'text-gray-600 hover:text-pink-600'}`}
            onClick={() => setActiveTab('basic')}
          >
            기본정보
          </button>
          <button
            type="button"
            className={`px-6 py-2 rounded-lg font-medium ${activeTab === 'images' ? 'bg-pink-100 text-pink-800' : 'text-gray-600 hover:text-pink-600'}`}
            onClick={() => setActiveTab('images')}
          >
            이미지
          </button>
          <button
            type="button"
            className={`px-6 py-2 rounded-lg font-medium ${activeTab === 'seo' ? 'bg-pink-100 text-pink-800' : 'text-gray-600 hover:text-pink-600'}`}
            onClick={() => setActiveTab('seo')}
          >
            SEO {seoFields.seo_score}/110
          </button>
        </div>
      </div>

      {activeTab === 'basic' && (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">상품명</label>
            <input
              type="text"
              value={formData.name}
              onChange={(e) => updateFormData({ name: e.target.value })}
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent"
              required
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">판매가</label>
            <input
              type="number"
              value={formData.salePrice}
              onChange={(e) => updateFormData({ salePrice: e.target.value })}
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
            />
          </div>
          {/* 기타 기본 필드들 */}
        </div>
      )}

      {activeTab === 'images' && (
        <div>
          <ImageUploader 
            images={formData.images}
            onImagesChange={(images) => updateFormData({ images })}
          />
        </div>
      )}

      {activeTab === 'seo' && (
        <ProductSeoForm 
          seoData={seoFields}
          onSeoChange={updateSeoFields}
          seoScore={seoFields.seo_score}
        />
      )}

      <div className="flex justify-end gap-3 pt-6 border-t">
        <Link href="/products/sourced" className="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
          취소
        </Link>
        <button
          type="submit"
          disabled={loading}
          className="px-8 py-3 bg-gradient-to-r from-pink-500 to-pink-600 text-white font-semibold rounded-lg hover:from-pink-600 hover:to-pink-700 disabled:opacity-50 flex items-center gap-2"
        >
          {loading ? (
            <>
              <Loader2 className="w-5 h-5 animate-spin" />
              저장중...
            </>
          ) : (
            <>
              <Save className="w-5 h-5" />
              {mode === 'create' ? '상품 등록' : '수정 저장'}
            </>
          )}
        </button>
      </div>
    </form>
  );
}
