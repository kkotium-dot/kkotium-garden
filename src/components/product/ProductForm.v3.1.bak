'use client';

import { useState, useEffect, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import ImageUploader from '@/components/products/ImageUploader';
import ProductSeoForm from './seo/ProductSeoForm';
import { Save, Loader2, ArrowLeft, Eye } from 'lucide-react';
import Link from 'next/link';

interface ProductFormProps {
  initialData?: any;
  onSave: (data: any) => Promise<void>;
  loading?: boolean;
  mode: 'create' | 'edit';
}

interface SafeSeoFields {
  title: string;
  description: string;
  keywords: string;
  naver_title: string;
  naver_description: string;
  og_image: string;
  seo_score: number;
  seo_valid: boolean;
}

export default function ProductForm({ 
  initialData = {}, 
  onSave, 
  loading = false, 
  mode 
}: ProductFormProps) {
  const router = useRouter();

  // 안전 초기값
  const getSafeSeoData = (data: any): SafeSeoFields => ({
    title: String(data?.title || data?.seo?.title || '').slice(0, 200),
    description: String(data?.description || data?.seo?.description || '').slice(0, 500),
    keywords: String(data?.keywords || data?.seo?.keywords || '').slice(0, 200),
    naver_title: String(data?.naver_title || '').slice(0, 200),
    naver_description: String(data?.naver_description || '').slice(0, 500),
    og_image: String(data?.og_image || data?.mainImage || ''),
    seo_score: Number(data?.seo_score || 0),
    seo_valid: Boolean(data?.seo_valid),
  });

  const [seoFields, setSeoFields] = useState<SafeSeoFields>(getSafeSeoData(initialData));
  const [formData, setFormData] = useState({
    name: String(initialData?.name || ''),
    salePrice: String(initialData?.salePrice || ''),
    supplierPrice: String(initialData?.supplierPrice || ''),
    shippingFee: String(initialData?.shippingFee || ''),
    category: String(initialData?.category || ''),
    status: String(initialData?.status || 'draft'),
    sku: String(initialData?.sku || ''),
    supplierId: String(initialData?.supplierId || ''),
    images: Array.isArray(initialData?.images) ? initialData.images : [],
    imageAltTexts: Array.isArray(initialData?.imageAltTexts) ? initialData.imageAltTexts : [],
  });

  const [activeTab, setActiveTab] = useState<'basic' | 'images' | 'seo'>('basic');

  // 실시간 SEO 검증 (입력 즉시)
  const validateSeo = useCallback(() => {
    let score = 0;
    const safeKeywords = String(seoFields.keywords || '');

    if (String(seoFields.title || '').length >= 10) score += 20;
    if (String(seoFields.description || '').length >= 50) score += 25;
    if (safeKeywords.split(',').filter(Boolean).length >= 3) score += 15;
    if (String(seoFields.naver_title || '').length >= 10) score += 20;
    if (String(seoFields.naver_description || '').length >= 50) score += 20;

    const valid = score >= 80;
    setSeoFields(prev => ({ ...prev, seo_score: score, seo_valid: valid }));
    return { valid, score };
  }, [seoFields]);

  const updateSeoFields = useCallback((updates: Partial<SafeSeoFields>) => {
    const newSeo = {
      ...seoFields,
      ...updates,
      title: String(updates.title || seoFields.title).slice(0, 200),
      description: String(updates.description || seoFields.description).slice(0, 500),
      keywords: String(updates.keywords || seoFields.keywords).slice(0, 200),
      naver_title: String(updates.naver_title || seoFields.naver_title).slice(0, 200),
      naver_description: String(updates.naver_description || seoFields.naver_description).slice(0, 500),
    };
    setSeoFields(newSeo);
    // 즉시 검증
    setTimeout(validateSeo, 50);
  }, [seoFields, validateSeo]);

  const updateFormData = useCallback((updates: any) => {
    setFormData(prev => ({ ...prev, ...updates }));
  }, []);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    const seoResult = validateSeo();

    if (!seoResult.valid) {
      alert(`SEO 점수 ${seoResult.score}/110 (80점 이상 필요)`);
      setActiveTab('seo');
      return;
    }

    if (!formData.name.trim()) {
      alert('상품명을 입력해주세요');
      setActiveTab('basic');
      return;
    }

    const submitData = {
      ...formData,
      ...seoFields,
      seo_score: seoResult.score,
      seo_valid: true,
    };

    await onSave(submitData);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-8">
      {/* 탭 */}
      <div className="border-b border-gray-200 pb-6">
        <nav className="-mb-px flex space-x-8">
          <button
            type="button"
            className={`py-2 px-4 border-b-2 font-medium whitespace-nowrap ${
              activeTab === 'basic'
                ? 'border-pink-500 text-pink-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            }`}
            onClick={() => setActiveTab('basic')}
          >
            기본정보
          </button>
          <button
            type="button"
            className={`py-2 px-4 border-b-2 font-medium whitespace-nowrap ${
              activeTab === 'images'
                ? 'border-pink-500 text-pink-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            }`}
            onClick={() => setActiveTab('images')}
          >
            이미지
          </button>
          <button
            type="button"
            className={`py-2 px-4 border-b-2 font-medium whitespace-nowrap ${
              activeTab === 'seo'
                ? 'border-pink-500 text-pink-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            }`}
            onClick={() => setActiveTab('seo')}
          >
            SEO {seoFields.seo_score}/110
          </button>
        </nav>
      </div>

      {/* 콘텐츠 */}
      {activeTab === 'basic' && (
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">상품명 *</label>
            <input
              type="text"
              value={formData.name}
              onChange={(e) => updateFormData({ name: e.target.value })}
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent"
              required
            />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">판매가</label>
              <input
                type="number"
                value={formData.salePrice}
                onChange={(e) => updateFormData({ salePrice: e.target.value })}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">공급가</label>
              <input
                type="number"
                value={formData.supplierPrice}
                onChange={(e) => updateFormData({ supplierPrice: e.target.value })}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500"
              />
            </div>
          </div>
          {/* 추가 필드 */}
        </div>
      )}

      {activeTab === 'images' && (
        <ImageUploader 
          images={formData.images}
          onImagesChange={(images) => updateFormData({ images })}
        />
      )}

      {activeTab === 'seo' && (
        <ProductSeoForm 
          seoData={seoFields}
          onSeoChange={updateSeoFields}
        />
      )}

      {/* 버튼 */}
      <div className="pt-6 border-t flex justify-end gap-3">
        <Link href="/products/sourced" className="px-6 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50">
          <ArrowLeft className="w-4 h-4 inline mr-1" />
          목록
        </Link>
        <button
          type="submit"
          disabled={loading}
          className="px-8 py-2.5 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-semibold rounded-lg hover:from-pink-600 hover:to-purple-700 disabled:opacity-50 flex items-center gap-2"
        >
          {loading ? <Loader2 className="w-4 h-4 animate-spin" /> : <Save className="w-4 h-4" />}
          {mode === 'create' ? '등록' : '수정'}
        </button>
      </div>
    </form>
  );
}
