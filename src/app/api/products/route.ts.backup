import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import { createId } from '@paralleldrive/cuid2';

// Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” (Service Role Key ì‚¬ìš©!)
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('âŒ Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
  console.error('   NEXT_PUBLIC_SUPABASE_URL:', supabaseUrl ? 'âœ…' : 'âŒ');
  console.error('   SUPABASE_SERVICE_ROLE_KEY:', supabaseServiceKey ? 'âœ…' : 'âŒ');
}

// Service Role Keyë¡œ Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± (ëª¨ë“  ê¶Œí•œ!)
const supabase = createClient(supabaseUrl, supabaseServiceKey);

console.log('âœ… Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ (Service Role Key ì‚¬ìš©)');

// SKU ìƒì„± í•¨ìˆ˜
function generateSKU(): string {
  const date = new Date();
  const year = date.getFullYear().toString().slice(-2);
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  const day = date.getDate().toString().padStart(2, '0');
  const random = Math.random().toString(36).substring(2, 6).toUpperCase();
  return `SKU${year}${month}${day}${random}`;
}

// POST: ìƒí’ˆ ì €ì¥
export async function POST(request: NextRequest) {
  try {
    console.log('\n' + '='.repeat(80));
    console.log('ğŸ’¾ ìƒí’ˆ ì €ì¥ API í˜¸ì¶œë¨ (Service Role Key ì‚¬ìš©)');
    console.log('='.repeat(80));

    // í™˜ê²½ ë³€ìˆ˜ ì²´í¬
    if (!supabaseUrl || !supabaseServiceKey) {
      console.error('âŒ Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤!');
      return NextResponse.json(
        {
          success: false,
          error: 'Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env.local íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.',
        },
        { status: 500 }
      );
    }

    const body = await request.json();
    console.log('ğŸ“¦ ìš”ì²­ ë°ì´í„°:', {
      name: body.name,
      supplierPrice: body.supplierPrice,
      salePrice: body.salePrice,
    });

    // IDì™€ SKU ìë™ ìƒì„±
    const id = createId(); // cuid2 ìƒì„±
    const sku = generateSKU();
    console.log('ğŸ†” ìƒì„±ëœ ID:', id);
    console.log('ğŸ·ï¸  ìƒì„±ëœ SKU:', sku);

    // ê¸°ë³¸ userId (ì¸ì¦ êµ¬í˜„ ì „ê¹Œì§€ ì„ì‹œ)
    const userId = 'temp-user-id';

    // ìƒí’ˆ ë°ì´í„° ì¤€ë¹„
    const productData = {
      id: id, // âœ… idë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬!
      userId: userId,
      name: body.name || 'ìƒí’ˆëª… ì—†ìŒ',
      sku: sku,
      vendorCode: body.vendorCode || null,
      category: body.category || 'ë¯¸ë¶„ë¥˜',
      supplierId: body.supplierId || null,
      supplierPrice: parseInt(body.supplierPrice) || 0,
      salePrice: parseInt(body.salePrice) || 0,
      margin: parseFloat(body.margin) || 0,
      shippingStrategy: body.shippingStrategy || 'free',
      freeShippingThreshold: body.freeShippingThreshold || null,
      shippingFee: parseInt(body.shippingFee) || 0,
      supplierShippingFee: parseInt(body.supplierShippingFee) || 0,
      supplierReturnFee: parseInt(body.supplierReturnFee) || 0,
      hasOptions: Boolean(body.hasOptions),
      optionName: body.optionName || null,
      optionValues: body.optionValues || null,
      mainImage: body.mainImage || null,
      additionalImages: body.additionalImages || null,
      description: body.description || null,
      keywords: body.keywords || null,
      status: body.status || 'DRAFT',
    };

    console.log('âœ… ìƒí’ˆ ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ');

    // Supabaseì— ì €ì¥ (Service Role Keyë¡œ ëª¨ë“  ê¶Œí•œ ë³´ìœ !)
    console.log('ğŸ’¾ Supabase ì €ì¥ ì‹œë„... (Service Role Key - ëª¨ë“  ê¶Œí•œ ë³´ìœ )');
    const { data, error } = await supabase
      .from('Product')
      .insert([productData])
      .select()
      .single();

    if (error) {
      console.error('\nâŒ Supabase ì €ì¥ ì—ëŸ¬:');
      console.error('ì—ëŸ¬ ì½”ë“œ:', error.code);
      console.error('ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
      console.error('ì—ëŸ¬ ìƒì„¸:', error.details);
      console.error('ì—ëŸ¬ íŒíŠ¸:', error.hint);

      return NextResponse.json(
        {
          success: false,
          error: `ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì‹¤íŒ¨: ${error.message}`,
          details: error.details,
          hint: error.hint,
        },
        { status: 500 }
      );
    }

    console.log('\nâœ… ìƒí’ˆ ì €ì¥ ì„±ê³µ!');
    console.log('ìƒí’ˆ ID:', data.id);
    console.log('SKU:', data.sku);
    console.log('='.repeat(80) + '\n');

    return NextResponse.json({
      success: true,
      message: 'ìƒí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
      product: data,
    });

  } catch (error: any) {
    console.error('\n' + '='.repeat(80));
    console.error('âŒ ìƒí’ˆ ì €ì¥ ì¤‘ ì˜ˆì™¸ ë°œìƒ');
    console.error('='.repeat(80));
    console.error('ì—ëŸ¬ ì´ë¦„:', error.name);
    console.error('ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
    console.error('ìŠ¤íƒ:', error.stack);
    console.error('='.repeat(80) + '\n');

    return NextResponse.json(
      {
        success: false,
        error: error.message || 'ìƒí’ˆ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
        details: error.toString(),
      },
      { status: 500 }
    );
  }
}

// GET: ìƒí’ˆ ëª©ë¡ ì¡°íšŒ
export async function GET(request: NextRequest) {
  try {
    console.log('\n' + '='.repeat(80));
    console.log('ğŸ“‹ ìƒí’ˆ ëª©ë¡ ì¡°íšŒ API í˜¸ì¶œë¨');
    console.log('='.repeat(80));

    const { searchParams } = new URL(request.url);
    const page = parseInt(searchParams.get('page') || '1');
    const limit = parseInt(searchParams.get('limit') || '20');
    const search = searchParams.get('search') || '';
    const sortBy = searchParams.get('sortBy') || 'createdAt';
    const sortOrder = searchParams.get('sortOrder') || 'desc';

    console.log('ğŸ“Š ì¡°íšŒ ì¡°ê±´:');
    console.log('  - í˜ì´ì§€:', page);
    console.log('  - ê°œìˆ˜:', limit);
    console.log('  - ê²€ìƒ‰ì–´:', search || 'ì—†ìŒ');
    console.log('  - ì •ë ¬:', sortBy, sortOrder);

    const from = (page - 1) * limit;
    const to = from + limit - 1;

    let query = supabase
      .from('Product')
      .select('*', { count: 'exact' })
      .order(sortBy, { ascending: sortOrder === 'asc' })
      .range(from, to);

    if (search) {
      query = query.ilike('name', `%${search}%`);
    }

    const { data, error, count } = await query;

    if (error) {
      console.error('\nâŒ ì¡°íšŒ ì—ëŸ¬:');
      console.error('ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
      console.error('ì—ëŸ¬ ìƒì„¸:', error.details);

      return NextResponse.json(
        {
          success: false,
          error: `ìƒí’ˆ ì¡°íšŒ ì‹¤íŒ¨: ${error.message}`,
        },
        { status: 500 }
      );
    }

    console.log('\nâœ… ì¡°íšŒ ì„±ê³µ!');
    console.log('ì´ ê°œìˆ˜:', count);
    console.log('í˜„ì¬ í˜ì´ì§€ ìƒí’ˆ ìˆ˜:', data?.length || 0);
    console.log('='.repeat(80) + '\n');

    return NextResponse.json({
      success: true,
      products: data || [],
      pagination: {
        page,
        limit,
        total: count || 0,
        totalPages: Math.ceil((count || 0) / limit),
      },
    });

  } catch (error: any) {
    console.error('\n' + '='.repeat(80));
    console.error('âŒ ìƒí’ˆ ì¡°íšŒ ì¤‘ ì˜ˆì™¸ ë°œìƒ');
    console.error('='.repeat(80));
    console.error('ì—ëŸ¬:', error);
    console.error('='.repeat(80) + '\n');

    return NextResponse.json(
      {
        success: false,
        error: error.message || 'ìƒí’ˆ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      },
      { status: 500 }
    );
  }
}

// DELETE: ìƒí’ˆ ì‚­ì œ
export async function DELETE(request: NextRequest) {
  try {
    const { searchParams } = new URL(request.url);
    const id = searchParams.get('id');

    if (!id) {
      return NextResponse.json(
        { success: false, error: 'ìƒí’ˆ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' },
        { status: 400 }
      );
    }

    console.log('\n' + '='.repeat(80));
    console.log('ğŸ—‘ï¸  ìƒí’ˆ ì‚­ì œ ìš”ì²­');
    console.log('='.repeat(80));
    console.log('ìƒí’ˆ ID:', id);

    const { error } = await supabase
      .from('Product')
      .delete()
      .eq('id', id);

    if (error) {
      console.error('\nâŒ ì‚­ì œ ì—ëŸ¬:');
      console.error(error);

      return NextResponse.json(
        {
          success: false,
          error: `ìƒí’ˆ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`,
        },
        { status: 500 }
      );
    }

    console.log('\nâœ… ì‚­ì œ ì„±ê³µ!');
    console.log('='.repeat(80) + '\n');

    return NextResponse.json({
      success: true,
      message: 'ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.',
    });

  } catch (error: any) {
    console.error('\n' + '='.repeat(80));
    console.error('âŒ ìƒí’ˆ ì‚­ì œ ì¤‘ ì˜ˆì™¸ ë°œìƒ');
    console.error('='.repeat(80));
    console.error(error);
    console.error('='.repeat(80) + '\n');

    return NextResponse.json(
      {
        success: false,
        error: error.message || 'ìƒí’ˆ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      },
      { status: 500 }
    );
  }
}
