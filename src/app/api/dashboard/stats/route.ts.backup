import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

// Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” (Service Role Key ì‚¬ìš©!)
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('âŒ Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
  console.error('   NEXT_PUBLIC_SUPABASE_URL:', supabaseUrl ? 'âœ…' : 'âŒ');
  console.error('   SUPABASE_SERVICE_ROLE_KEY:', supabaseServiceKey ? 'âœ…' : 'âŒ');
}

// Service Role Keyë¡œ Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± (ëª¨ë“  ê¶Œí•œ!)
const supabase = createClient(supabaseUrl, supabaseServiceKey);

console.log('âœ… Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ (Dashboard Stats API)');

// GET: ëŒ€ì‹œë³´ë“œ í†µê³„
export async function GET(request: NextRequest) {
  try {
    console.log('\n' + '='.repeat(80));
    console.log('ğŸ“Š ëŒ€ì‹œë³´ë“œ í†µê³„ API í˜¸ì¶œë¨ (Service Role Key ì‚¬ìš©)');
    console.log('='.repeat(80));

    // í™˜ê²½ ë³€ìˆ˜ ì²´í¬
    if (!supabaseUrl || !supabaseServiceKey) {
      console.error('âŒ Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤!');
      return NextResponse.json({
        totalProducts: 0,
        totalRevenue: 0,
        totalProfit: 0,
        averageMargin: 0,
        error: 'Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'
      });
    }

    // ì „ì²´ ìƒí’ˆ ì¡°íšŒ (Product í…Œì´ë¸” - ëŒ€ë¬¸ì P!)
    console.log('ğŸ’¾ Product í…Œì´ë¸” ì¡°íšŒ ì‹œì‘...');
    const { data: products, error, count } = await supabase
      .from('Product')  // âœ… ëŒ€ë¬¸ì P!
      .select('*', { count: 'exact' });

    if (error) {
      console.error('\nâŒ Supabase ì¡°íšŒ ì—ëŸ¬:');
      console.error('ì—ëŸ¬ ì½”ë“œ:', error.code);
      console.error('ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
      console.error('ì—ëŸ¬ ìƒì„¸:', error.details);

      return NextResponse.json({
        totalProducts: 0,
        totalRevenue: 0,
        totalProfit: 0,
        averageMargin: 0,
        error: error.message
      });
    }

    console.log('\nâœ… ì¡°íšŒ ì„±ê³µ!');
    console.log('ì´ ìƒí’ˆ ìˆ˜:', products?.length || 0);
    console.log('Count:', count);

    // ìƒí’ˆì´ ì—†ìœ¼ë©´ 0 ë°˜í™˜
    if (!products || products.length === 0) {
      console.log('âš ï¸  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤');
      console.log('='.repeat(80) + '\n');

      return NextResponse.json({
        totalProducts: 0,
        totalRevenue: 0,
        totalProfit: 0,
        averageMargin: 0,
      });
    }

    // í†µê³„ ê³„ì‚°
    console.log('\nğŸ“ˆ í†µê³„ ê³„ì‚° ì‹œì‘...');
    let totalRevenue = 0;
    let totalProfit = 0;
    let totalMargin = 0;

    products.forEach(product => {
      // camelCase í•„ë“œëª… ì‚¬ìš© (Product í…Œì´ë¸”)
      const supplierPrice = product.supplierPrice || 0;
      const salePrice = product.salePrice || 0;
      const shippingCost = product.shippingFee || 0;

      const cost = supplierPrice + shippingCost;
      const fee = salePrice * 0.058; // ë„¤ì´ë²„ ìˆ˜ìˆ˜ë£Œ 5.8%
      const profit = salePrice - cost - fee;
      const margin = salePrice > 0 ? (profit / salePrice) * 100 : 0;

      totalRevenue += salePrice;
      totalProfit += profit;
      totalMargin += margin;

      console.log(`  ğŸ“¦ ${product.name || product.sku}`);
      console.log(`     íŒë§¤ê°€: ${salePrice.toLocaleString()}ì›, ë§ˆì§„: ${margin.toFixed(1)}%`);
    });

    // í‰ê·  ë§ˆì§„ìœ¨
    const averageMargin = products.length > 0 ? totalMargin / products.length : 0;

    const result = {
      totalProducts: products.length,
      totalRevenue: Math.round(totalRevenue),
      totalProfit: Math.round(totalProfit),
      averageMargin: parseFloat(averageMargin.toFixed(2)),
    };

    console.log('\nğŸ“Š ìµœì¢… í†µê³„:');
    console.log('  - ì „ì²´ ìƒí’ˆ:', result.totalProducts, 'ê°œ');
    console.log('  - ì´ ë§¤ì¶œ:', result.totalRevenue.toLocaleString(), 'ì›');
    console.log('  - ìˆœì´ìµ:', result.totalProfit.toLocaleString(), 'ì›');
    console.log('  - í‰ê·  ë§ˆì§„ìœ¨:', result.averageMargin, '%');
    console.log('='.repeat(80) + '\n');

    return NextResponse.json(result);

  } catch (error: any) {
    console.error('\n' + '='.repeat(80));
    console.error('âŒ ëŒ€ì‹œë³´ë“œ í†µê³„ ì¡°íšŒ ì¤‘ ì˜ˆì™¸ ë°œìƒ');
    console.error('='.repeat(80));
    console.error('ì—ëŸ¬ ì´ë¦„:', error.name);
    console.error('ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
    console.error('ìŠ¤íƒ:', error.stack);
    console.error('='.repeat(80) + '\n');

    return NextResponse.json({
      totalProducts: 0,
      totalRevenue: 0,
      totalProfit: 0,
      averageMargin: 0,
      error: error.message || 'í†µê³„ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
}
